{"version":3,"file":"grade_handler.min.js","sources":["../src/grade_handler.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * AMD module for block_grade_activity.\n *\n * Handles:\n *  - Search / filtering of the student table.\n *  - \"Dirty\" detection to enable / disable the Save button.\n *  - AJAX calls to enable_grading and save_grades web-service functions.\n *  - Toast notification on success.\n *\n * @module     block_grade_activity/grade_handler\n * @copyright  2025 Your Name\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport Ajax from 'core/ajax';\nimport Notification from 'core/notification';\nimport {add as addToast} from 'core/toast';\nimport {get_string as getString} from 'core/str';\n\n// ---------------------------------------------------------------------------\n// Setup state – \"Enable Grading\" button\n// ---------------------------------------------------------------------------\n\n/**\n * Initialise the setup-state UI.\n *\n * @param {number} cmid Course-module ID.\n */\nexport const initSetup = (cmid) => {\n    const container = document.querySelector('.block_grade_activity_setup');\n    if (!container) {\n        return;\n    }\n\n    const enableBtn = container.querySelector('#grade-activity-enable');\n    if (!enableBtn) {\n        return;\n    }\n\n    enableBtn.addEventListener('click', () => {\n        enableBtn.disabled = true;\n        enableBtn.textContent = '…';\n\n        Ajax.call([{\n            methodname: 'block_grade_activity_enable_grading',\n            args: {cmid},\n            done: () => {\n                // Reload the page so the block re-renders in \"active\" state.\n                window.location.reload();\n            },\n            fail: (err) => {\n                enableBtn.disabled = false;\n                Notification.exception(err);\n            },\n        }]);\n    });\n};\n\n// ---------------------------------------------------------------------------\n// Active state – grading interface\n// ---------------------------------------------------------------------------\n\n/**\n * Initialise the grading-interface UI.\n *\n * @param {number} cmid     Course-module ID.\n * @param {number} grademax Maximum allowed grade.\n */\nexport const init = (cmid, grademax) => {\n    const container = document.querySelector('.block_grade_activity_grading');\n    if (!container) {\n        return;\n    }\n\n    const searchInput = container.querySelector('#grade-activity-search');\n    const saveButton  = container.querySelector('#grade-activity-save');\n    const gradeInputs = container.querySelectorAll('.grade-input');\n\n    if (!saveButton || gradeInputs.length === 0) {\n        return;\n    }\n\n    // Store original values so we can detect changes.\n    const originalValues = new Map();\n    gradeInputs.forEach((input) => {\n        originalValues.set(input.dataset.userid, input.value);\n    });\n\n    // ----- Search / filter -------------------------------------------------\n\n    if (searchInput) {\n        searchInput.addEventListener('input', () => {\n            const query = searchInput.value.trim().toLowerCase();\n            const rows  = container.querySelectorAll('#grade-activity-table tbody tr');\n\n            rows.forEach((row) => {\n                const nameCell = row.querySelector('.student-name');\n                if (!nameCell) {\n                    return;\n                }\n                const name    = nameCell.textContent.toLowerCase();\n                row.hidden = query !== '' && !name.includes(query);\n            });\n        });\n    }\n\n    // ----- Dirty-state tracking --------------------------------------------\n\n    const checkDirty = () => {\n        let dirty = false;\n        gradeInputs.forEach((input) => {\n            if (input.value !== originalValues.get(input.dataset.userid)) {\n                dirty = true;\n            }\n        });\n        saveButton.disabled = !dirty;\n    };\n\n    gradeInputs.forEach((input) => {\n        input.addEventListener('input', checkDirty);\n    });\n\n    // ----- Validation helper -----------------------------------------------\n\n    /**\n     * Return true if the value is a valid grade within range.\n     *\n     * @param  {string}  val Raw input value.\n     * @return {boolean}\n     */\n    const isValidGrade = (val) => {\n        if (val === '') {\n            return true; // Empty means \"no change\".\n        }\n        const num = parseFloat(val);\n        return !isNaN(num) && num >= 0 && num <= grademax;\n    };\n\n    // Highlight invalid inputs on blur.\n    gradeInputs.forEach((input) => {\n        input.addEventListener('blur', () => {\n            if (!isValidGrade(input.value)) {\n                input.classList.add('is-invalid');\n            } else {\n                input.classList.remove('is-invalid');\n            }\n        });\n    });\n\n    // ----- Save handler ----------------------------------------------------\n\n    saveButton.addEventListener('click', async () => {\n        // Collect changed & valid grades.\n        const grades = [];\n        let hasInvalid = false;\n\n        gradeInputs.forEach((input) => {\n            const uid = input.dataset.userid;\n\n            // Skip unchanged.\n            if (input.value === originalValues.get(uid)) {\n                return;\n            }\n\n            // Skip empty (user cleared a grade – not sent).\n            if (input.value === '') {\n                return;\n            }\n\n            if (!isValidGrade(input.value)) {\n                hasInvalid = true;\n                input.classList.add('is-invalid');\n                return;\n            }\n\n            grades.push({\n                userid: parseInt(uid, 10),\n                grade:  parseFloat(input.value),\n            });\n        });\n\n        if (hasInvalid) {\n            const msg = await getString('invalidgrade', 'block_grade_activity', grademax);\n            Notification.addNotification({message: msg, type: 'error'});\n            return;\n        }\n\n        if (grades.length === 0) {\n            return;\n        }\n\n        // Disable button while saving.\n        saveButton.disabled = true;\n        const originalLabel = saveButton.textContent;\n        saveButton.textContent = await getString('saving', 'block_grade_activity');\n\n        Ajax.call([{\n            methodname: 'block_grade_activity_save_grades',\n            args: {cmid, grades},\n            done: async () => {\n                // Update stored originals.\n                gradeInputs.forEach((input) => {\n                    originalValues.set(input.dataset.userid, input.value);\n                });\n\n                saveButton.textContent = originalLabel;\n                saveButton.disabled = true; // No longer dirty.\n\n                const successMsg = await getString('gradessaved', 'block_grade_activity');\n                addToast(successMsg);\n            },\n            fail: (err) => {\n                saveButton.textContent = originalLabel;\n                checkDirty();\n                Notification.exception(err);\n            },\n        }]);\n    });\n};\n"],"names":["_interopRequireDefault","e","__esModule","default","_ajax","_notification","_exports","initSetup","cmid","container","document","querySelector","enableBtn","addEventListener","disabled","textContent","Ajax","call","methodname","args","done","window","location","reload","fail","err","Notification","exception","init","grademax","searchInput","saveButton","gradeInputs","querySelectorAll","length","originalValues","Map","forEach","input","set","dataset","userid","value","query","trim","toLowerCase","row","nameCell","name","hidden","includes","checkDirty","dirty","get","isValidGrade","val","num","parseFloat","isNaN","classList","remove","add","async","grades","hasInvalid","uid","push","parseInt","grade","msg","getString","addNotification","message","type","originalLabel","successMsg","addToast"],"mappings":"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"}